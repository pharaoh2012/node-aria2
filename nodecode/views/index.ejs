<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="author" content="Pharaoh" />
		<title>[<%= curPath %>]  -- File List</title>
    <style type="text/css">
    table {
      width:100%;
      max-width: 900px;
      font-size: 20px;
    }
    tr:nth-child(odd) {
      background: #EEF3FF;
    }
    a {
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    </style>
	</head>
<body>
<h1>Current Path:<%= curPath %>
<form method="post" enctype="multipart/form-data" action="?cmd=upload">
  <input type="file" name="files">
  <input type="submit">
</form>
</h1>
<h2>Directorys: <button onclick="createDir();">New Dir</button></h2>
  <table>
    <% paths.forEach(function(path){ %>
      <tr>
      <td><a href="<%= path.name %>/"><%= path.name %></a></td>
      <td><b> <%= path.time %> </b></td>
      <td>
      <% if(path.name != '..') { %>
        <button onclick='changeName("<%= path.name %>")'>Rename</button>
        <button onclick='deletePath("<%= path.name %>")'>Delete</button>    
      <% } %>    
      </td>
      </tr>
    <% }) %>
  </table>
<h2>Files:</h2>
  <table>
    <% files.forEach(function(file){ %>
      <tr>
      <td><a href="<%= file.name %>"><%= file.name %></a>  </td>
      <td>
        <b><%= file.time %></b>
      </td>
      <td>
        <i> <%= file.size %></i>
      </td>
      <td>
        <button onclick='changeName("<%= file.name %>")'>Rename</button>
        <button onclick='deleteFile("<%= file.name %>")'>Delete</button> 
        <!-- <button onclick='unzip("<%= file.name %>")'>Unzip</button> -->
        <button onclick='downtoxiaom("<%= file.name %>")'>下载到小米路由器</button>
      </td>
       

      </tr>
    <% }) %>
  </table>


<script type="text/javascript">
//base64
(function(global){"use strict";var _Base64=global.Base64;var version="2.1.9";var buffer;if(typeof module!=="undefined"&&module.exports){try{buffer=require("buffer").Buffer}catch(err){}}var b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64tab=function(bin){var t={};for(var i=0,l=bin.length;i<l;i++)t[bin.charAt(i)]=i;return t}(b64chars);var fromCharCode=String.fromCharCode;var cb_utob=function(c){if(c.length<2){var cc=c.charCodeAt(0);return cc<128?c:cc<2048?fromCharCode(192|cc>>>6)+fromCharCode(128|cc&63):fromCharCode(224|cc>>>12&15)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}else{var cc=65536+(c.charCodeAt(0)-55296)*1024+(c.charCodeAt(1)-56320);return fromCharCode(240|cc>>>18&7)+fromCharCode(128|cc>>>12&63)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}};var re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;var utob=function(u){return u.replace(re_utob,cb_utob)};var cb_encode=function(ccc){var padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|(ccc.length>1?ccc.charCodeAt(1):0)<<8|(ccc.length>2?ccc.charCodeAt(2):0),chars=[b64chars.charAt(ord>>>18),b64chars.charAt(ord>>>12&63),padlen>=2?"=":b64chars.charAt(ord>>>6&63),padlen>=1?"=":b64chars.charAt(ord&63)];return chars.join("")};var btoa=global.btoa?function(b){return global.btoa(b)}:function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode)};var _encode=buffer?function(u){return(u.constructor===buffer.constructor?u:new buffer(u)).toString("base64")}:function(u){return btoa(utob(u))};var encode=function(u,urisafe){return!urisafe?_encode(String(u)):_encode(String(u)).replace(/[+\/]/g,function(m0){return m0=="+"?"-":"_"}).replace(/=/g,"")};var encodeURI=function(u){return encode(u,true)};var re_btou=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g");var cb_btou=function(cccc){switch(cccc.length){case 4:var cp=(7&cccc.charCodeAt(0))<<18|(63&cccc.charCodeAt(1))<<12|(63&cccc.charCodeAt(2))<<6|63&cccc.charCodeAt(3),offset=cp-65536;return fromCharCode((offset>>>10)+55296)+fromCharCode((offset&1023)+56320);case 3:return fromCharCode((15&cccc.charCodeAt(0))<<12|(63&cccc.charCodeAt(1))<<6|63&cccc.charCodeAt(2));default:return fromCharCode((31&cccc.charCodeAt(0))<<6|63&cccc.charCodeAt(1))}};var btou=function(b){return b.replace(re_btou,cb_btou)};var cb_decode=function(cccc){var len=cccc.length,padlen=len%4,n=(len>0?b64tab[cccc.charAt(0)]<<18:0)|(len>1?b64tab[cccc.charAt(1)]<<12:0)|(len>2?b64tab[cccc.charAt(2)]<<6:0)|(len>3?b64tab[cccc.charAt(3)]:0),chars=[fromCharCode(n>>>16),fromCharCode(n>>>8&255),fromCharCode(n&255)];chars.length-=[0,0,2,1][padlen];return chars.join("")};var atob=global.atob?function(a){return global.atob(a)}:function(a){return a.replace(/[\s\S]{1,4}/g,cb_decode)};var _decode=buffer?function(a){return(a.constructor===buffer.constructor?a:new buffer(a,"base64")).toString()}:function(a){return btou(atob(a))};var decode=function(a){return _decode(String(a).replace(/[-_]/g,function(m0){return m0=="-"?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};var noConflict=function(){var Base64=global.Base64;global.Base64=_Base64;return Base64};global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict};if(typeof Object.defineProperty==="function"){var noEnum=function(v){return{value:v,enumerable:false,writable:true,configurable:true}};global.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",noEnum(function(){return decode(this)}));Object.defineProperty(String.prototype,"toBase64",noEnum(function(urisafe){return encode(this,urisafe)}));Object.defineProperty(String.prototype,"toBase64URI",noEnum(function(){return encode(this,true)}))}}if(global["Meteor"]){Base64=global.Base64}})(this);



function unzip (filename) {
  if(confirm("unzip file:"+filename+"?")) {
    var url = '?cmd=unzip&filename='+encodeURIComponent(filename);
    getUrl(url,function(ret){
      alert(ret);
      if(ret == "ok") {
        location.reload();
      }
      
    });      
  }  
}

function run (filename) {
  if(confirm("run file:"+filename+"?")) {
    var url = '?cmd=run&filename='+encodeURIComponent(filename);
    getUrl(url,function(ret){
      alert(ret);
      if(ret == "ok") {
        location.reload();
      }
    });
  }  
}


function createDir () {
    var newdir = prompt("Input new dirname:");
    if(newdir) {
      var url = '?cmd=newdir&newdir='+encodeURIComponent(newdir);
      getUrl(url,function(ret){
        alert(ret);
        location.reload();
      });
    }
}

  function deletePath (filename) {
    if(filename == "..") return;
    if(confirm("Delete path:"+filename+"?")) {
      var url = '?cmd=deletepath&filename='+encodeURIComponent(filename);
      getUrl(url,function(ret){
        alert(ret);
        if(ret == "ok") {
          location.reload();
        }
        
      });      
    }

  }
  function deleteFile (filename) {
    if(filename == "..") return;
    if(confirm("Delete file:"+filename+"?")) {
      var url = '?cmd=delete&filename='+encodeURIComponent(filename);
      getUrl(url,function(ret){
        alert(ret);
        if(ret == "ok") {
          location.reload();
        }
        
      });      
    }

  }

  function downtoxiaom(filename) {
    var fullurl = location.origin+location.pathname + filename;
    console.info(fullurl);
    var url64 = Base64.encode(fullurl);
    var xmurl = "https://d.miwifi.com/d2r/?url="+url64 + "&name=" + encodeURIComponent(filename);
    console.info(url64,xmurl);
    window.open(xmurl);
  }

  function changeName (filename) {
    if(filename == "..") return;
    var newfn = prompt("Input new filename:",filename);
    if(newfn) {
      if(newfn == filename) {
        alert("the same filename");
        return ;
      }
      var url = '?cmd=rename&oldfn='+encodeURIComponent(filename)+"&newfn="+encodeURIComponent(newfn);
      getUrl(url,function(ret){
        alert(ret);
        location.reload();
      });
    }
  }
function getUrl(url, fn) {
    var req = new XMLHttpRequest();
    req.open("GET", url, true);
    console.debug("getUrl:", url);
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            if (req.status == 200) {
                if (req.responseText.indexOf("error:") == 0) {
                    alert(req.responseText);
                }
                if (fn) fn(req.responseText);
            } else {
                alert("getUrl Error:" + req.status + "\n" + url);
            }
        }
    };
    req.send(null);
}  

</script>

</body>
</html>